var tempOverlapping;function setOverlapping(){var e=hot.Methods.getSelected(),l={};if(e){var a=e[0],o=hot.Methods.getCellMeta(a[0],a[1]),n=hot.Methods.getCell(a[0],a[1]);l=o.overlapping||{},layer.open({type:1,area:["700px","410px"],title:"交叉表头配置",content:$("#overlapping"),cancel:function(){},success:function(e,t){(tempOverlapping=e).find("#view-border").width($(n).outerWidth()).height($(n).outerHeight()-1),e.find("#lineHeight").val($(n).outerHeight()-1),e.find("#lineWidth").val($(n).outerWidth()),e.find("#view-td").css("background-image","").empty(),e.find("#line").val(0),e.find("#overlap-items").empty(),e.find("#lineHeight").bind("input propertychange",function(){e.find("#view-border").height($(this).val())}),e.find("#lineWidth").bind("input propertychange",function(){e.find("#view-border").width($(this).val())}),e.find("#line").bind("change",function(){createItmes($(this).val())}),e.find("#viewOverlap").bind("click",function(){createViewLine()}),e.find("#overlapping-fontsize").bind("change input",function(){$(".overlap-node").css("font-size",this.value+"px")}),e.find(".overlapping-color").spectrum({showInput:!0,allowEmpty:!0,showAlpha:!0,cancelText:"取消",chooseText:"确认",togglePaletteMoreText:"更多",togglePaletteLessText:"简略",change:function(e){if("overlapping-bgcolor"==this.id)$("#view-td").css("background-color",e.toRgbaString());else if("overlapping-fontcolor"==this.id)$(".overlap-node").css("color",e.toRgbString());else if("overlapping-linecolor"==this.id){line(tempOverlapping.find("#view-td")[0],1,e.toRgbaString(),$("#line").val())}},show:function(e){},move:function(e){}}),initOverlapping(l,e)},end:function(){},btn:["保存","取消"],yes:function(t,n){var i=tempOverlapping.find("#view-td");html2canvas(i[0]).then(function(e){l.base64=e.toDataURL(),l.nodes=[],i.find(".overlap-node").each(function(){var e={};e.top=$(this).css("top"),e.left=$(this).css("left"),e.value=$(this).text(),l.nodes.push(e)}),o.overlapping=l,hot.Methods.setCellMetaObject(a[0],a[1],o),TableData.rowHeights[a[0]]=Number(n.find("#lineHeight").val()),TableData.colWidths[a[1]]=Number(n.find("#lineWidth").val()),hot.Methods.disablePlugin(),tb_updateSettings(),hot.Methods.enablePlugin(),layer.close(t)})},btn2:function(e,t){layer.close(e)}})}}function clearoverlapping(){var e=hot.Methods.getSelected();if(e){var t=e[0],n=hot.Methods.getCell(t[0],t[1]);delete hot.Methods.getCellMeta(t[0],t[1]).overlapping,n.style.backgroundImage=""}}function initOverlapping(e,t){var n=e.nodes;n&&1<n.length&&(t.find("#line").val(n.length-1),createItmes(n.length-1,n),createViewLine(n))}function createItmes(e,t){var n=tempOverlapping.find("#overlap-items");n.empty();for(var i=0;i<Number(e)+1;i++)if(t){var l=$('<div class="linenames-div"><input type="text" value="'+t[i].value+'" name="linenames" placeholder="请输入第'+(i+1)+'个参数" /></div>');n.append(l)}else{l=$('<div class="linenames-div"><input type="text" name="linenames" placeholder="请输入第'+(i+1)+'个参数" /></div>');n.append(l)}}function createViewLine(e){var t=tempOverlapping.find("#view-td"),n=$("#overlapping-linecolor").spectrum("get").toRgbaString();if(e)line(t[0],1,n,e.length-1),addLabels(t,e);else{var i=tempOverlapping.find(".linenames-div"),l=[];$.each(i,function(){var e={};e.value=$(this).find("[name=linenames]").val(),l.push(e)}),line(t[0],1,n,i.length-1),addLabels(t,l)}}function addLabels(i,e){i.empty(),$.each(e,function(e,t){var n=$('<label class="overlap-node">'+t.value+"</label>");n.appendTo(i),n.myDrag({randomPosition:!1,direction:"all",handler:!1,elem:i}),t.top&&n.css("top",t.top),t.left&&n.css("left",t.left),n.css("color",$("#overlapping-fontcolor").spectrum("get").toRgbString()),n.css("font-size",$("#overlapping-fontsize").val()+"px")})}function createLine(e,t,n){if(!e&&0<=t&0<=n){e=hot.Methods.getCellMeta(t,n).overlapping;var i=hot.Methods.getCell(t,n,!1);e.base64=line(i,1,"#000000",e.val),hot.Methods.setCellMeta(t,n,"overlapping",e)}else{var l=hot.Methods.getSelected();if(l){var a=l[0];hot.Methods.getCellMeta(a[0],a[1]),i=hot.Methods.getCell(a[0],a[1],!1);e.base64=line(i,1,"#000000",e.val),hot.Methods.setCellMeta(a[0],a[1],"overlapping",e),TableData.overlapping[a[0]]||(TableData.overlapping[a[0]]=[]),TableData.overlapping[a[0]][a[1]]=e.val}}}function line(e,t,n,i){var l=e.clientWidth,a=e.clientHeight,o=document.createElement("CANVAS");o.width=l,o.height=a;var r=o.getContext("2d");switch(r.clearRect(0,0,l,a),r.fill(),r.lineWidth=t,r.strokeStyle=n,r.beginPath(),Number(i)){case 1:r.moveTo(0,0),r.lineTo(l,a);break;case 2:r.moveTo(0,0),r.lineTo(l/2,a),r.moveTo(0,0),r.lineTo(l,a/2);break;case 3:r.moveTo(0,0),r.lineTo(l,a),r.moveTo(0,0),r.lineTo(l/2,a),r.moveTo(0,0),r.lineTo(l,a/2);break;default:return 0}r.stroke(),r.closePath();var s=r.canvas.toDataURL();return e.style.backgroundImage='url("'+s+'")',e.style.backgroundRepeat="no-repeat",$(o).remove(),s}