var tempTreeNodeForSets,tempCoordsForSets,tempLayeroForSets,tempLayeroForJsonField,dragFlagForSets=!1,settingForSets={view:{addHoverDom:addHoverDomForSets,removeHoverDom:removeHoverDomForSets,addDiyDom:addDiyDomForSets},data:{simpleData:{enable:!0}},edit:{drag:{autoExpandTrigger:!0,prev:function(e,t,a){return!(!a.getParentNode()||"parms"!=a.getParentNode().type)},inner:function(e,t,a){return a&&"parms"==a.type},next:function(e,t,a){return!(!a.getParentNode()||"parms"!=a.getParentNode().type)},isCopy:!0,isMove:!1},enable:!0,showRenameBtn:!1,showRemoveBtn:function(e,t){return 1==t.level},removeTitle:"删除"},callback:{beforeDrag:beforeDragForSets,beforeDrop:beforeDropForSets,onDrag:onDragForSets,onDrop:onDropForSets,onClick:zTreeOnClickForSets,beforeRemove:zTreeBeforeRemoveForSets}},zNodesForSets=[{id:1,pId:0,name:"数据集列表",open:!0}];function getDataSetsNodesByParam(e,t,a){return $.fn.zTree.getZTreeObj("dataSets").getNodesByParam(e,t,a)}function addDiyDomForSets(e,t){if(0==t.level){$("#"+t.tId+"_a").append('<button type="button" class="tb_btn" id="addDataSetsBtn" onclick="addDataSets()">新增数据集</button>')}}function beforeDragForSets(e,t){return"field"==t[0].type||"field"==t[0].getParentNode().type&&3==t[0].level}function beforeDropForSets(e,t,a,o,n){return!0}function onDragForSets(e,t,a){dragFlagForSets=!0}function onDropForSets(e,t,a,o,n,d){if(dragFlagForSets=!1,a[0].type&&"field"==a[0].type){var i=a[0].getParentNode().name,r=a[0].children,s=Number(tempCoordsForSets.row),l=Number(tempCoordsForSets.col);$.each(r,function(e,t){hot.Methods.setDataAtCell(s,l+e,"="+i+"."+t.name),hot.Methods.setCellMeta(s,l+e,"columnName",t.columnName),hot.Methods.setCellMeta(s,l+e,"columnType",t.columnType)}),tempCoordsForSets={},console.log(a[0])}else{i=a[0].getParentNode().getParentNode().name;hot.Methods.setDataAtCell(tempCoordsForSets.row,tempCoordsForSets.col,"="+i+"."+a[0].name),hot.Methods.setCellMeta(tempCoordsForSets.row,tempCoordsForSets.col,"columnName",a[0].columnName),hot.Methods.setCellMeta(tempCoordsForSets.row,tempCoordsForSets.col,"columnType",a[0].columnType),tempCoordsForSets={}}}function setCoords(e){tempCoordsForSets=e}function zTreeOnClickForSets(e,t,a){}function zTreeBeforeRemoveForSets(e,t){return layer.confirm("确认删除数据集  “"+t.name+"” 吗？",{btn:["确定","取消"]},function(e){$.fn.zTree.getZTreeObj("dataSets").removeNode(t),layer.alert("删除成功!")},function(e){layer.close(e)}),!1}function addHoverDomForSets(e,t){if(1!=t.level)return removeSql(),!1;showSql(t);var a=$("#"+t.tId+"_span");if(!(t.editNameFlag||0<$("#"+t.tId+"_editBtn").length)){var o="<span class='button edit' id='"+t.tId+"_editBtn' title='修改' onfocus='this.blur();'></span>";a.after(o);var n=$("#"+t.tId+"_editBtn");n&&n.bind("click",function(){return addDataSets(t),!1})}}function removeHoverDomForSets(e,t){if(removeSql(t),1!=t.level)return!1;$("#"+t.tId+"_editBtn").unbind().remove()}function addParmItem(e){var t=$('<div class="parm-item"><select></select><div class="btn-group"><i class="icon icon-insert"onclick="addParmItem(this);">+</i><i class="icon icon-del"onclick="delParmItem(this)">-</i></div></div>'),a=$.fn.zTree.getZTreeObj("dataParms").getNodesByParam("level","1",null),o=t.find("select");($.each(a,function(e,t){o.append('<option value="'+t.parmName+'">'+t.parmCName+"</option>")}),e)?$(e).parents(".parm-item").after(t):tempLayeroForSets.find(".parm-list").append(t)}function addParmItemForEdit(e,t,a){var o=$.fn.zTree.getZTreeObj("dataParms").getNodesByParam("level","1",null),n="";$.each(o,function(e,t){n+="<option value='"+t.parmName+"'>"+(t.parmCName||t.parmName)+"</option>"});var d,i=$.fn.zTree.getZTreeObj("dataSets").getNodesByParam("type","parms",t)[0].children;d="json"==a?e.find("#jsonlist .parm-list"):e.find("#ddslist .parm-list"),i&&0<i.length&&$.each(i,function(e,t){var a=$('<div class="parm-item"><select></select><div class="btn-group"><i class="icon icon-insert"onclick="addParmItem(this);">+</i><i class="icon icon-del"onclick="delParmItem(this)">-</i></div></div>'),o=a.find("select");o.append(n),o.val(t.parmName),d.append(a)})}function delParmItem(e){$(e).parents(".parm-item").remove()}function showSql(e){var t=sqlFormatter.format(e.commandText),a=new RegExp("\n|\r\n","g"),o=t.replace(a,"</br>").replace(/\s/g,"&nbsp;&nbsp;");$(".showsql").unbind().remove();var n=$('<div class="showsql" id="'+e.tId+'_showsql"></div>'),d=$("#"+e.tId+"_a"),i=rdpConfig.getConfigParm("dataSet");n.append("&nbsp;&nbsp;&nbsp;&nbsp;"+o),hljs.configure({useBR:!0,languages:["sql"]}),n.each(function(e,t){hljs.highlightBlock(t)}),n.appendTo("body"),"left"==i?n.css({"min-width":"200px","min-height":"200px",top:"10px",right:"410px",position:"absolute",border:"1px solid #b4b4b4","border-radius":"5px","z-index":999}):(n.css({"min-width":"200px","min-height":"200px",left:d.offset().left+"px",position:"absolute",border:"1px solid #b4b4b4","border-radius":"5px","z-index":999}),n.css("top",d.offset().top-n.outerHeight(!0)+"px")),n.bind("click",function(){return!1})}function removeSql(e){$(".showsql").remove()}function addDataSets(a){layer.open({type:1,area:["640px","480px"],title:"数据集配置",content:$("#dataSetsInfo"),cancel:function(){},success:function(o,e){(tempLayeroForSets=o).find("#DataSourceName").empty(),o.find("#hostName").empty(),o.find("#pageprop").hide(),o.find("#pageParam").val(""),o.find("#recordName").val(""),o.find("#DataSourceName").append('<option value=""></option><option value="javabean">javabean</option><option value="json">API请求</option>'),$(document).queue("dsQuery",function(){$.rdp.ajax({url:"../../rdp/selectAllDataSourceName",type:"post",async:!0,success:function(e){for(var t=e.list,a=0;a<t.length;a++)o.find("#DataSourceName").append("<option value='"+t[a].dataSourceName+"'>"+t[a].dataSourceName+"</option>");$(document).dequeue("dsQuery")}})}),$(document).queue("dsQuery",function(){$.rdp.ajax({url:"../../rdp/selectAllJSONName",type:"post",async:!0,success:function(e){for(var t=e.list,a=0;a<t.length;a++)o.find("#hostName").append("<option value='"+t[a].dataSourceName+"'>"+t[a].dataSourceName+"</option>");$(document).dequeue("dsQuery")}})}),$(document).queue("dsQuery",function(){o.find("#DataSourceName").unbind().bind("change",function(){$(o).find("#jblist").hide(),$(o).find("#ddslist").hide(),$(o).find("#jsonlist").hide(),"javabean"==$(this).val()?$(o).find("#jblist").show():"json"==$(this).val()?$(o).find("#jsonlist").show():$(o).find("#ddslist").show()}),o.find("#pageType").unbind().bind("change",function(){0==$(this).val()?$(o).find("#pageprop").hide():$(o).find("#pageprop").show()}),o.find(".formatterBtn").unbind().bind("click",function(){var e=tempLayeroForSets.find("#CommandText").val(),t=sqlFormatter.format(e);tempLayeroForSets.find("#CommandText").val(t)}),o.find("#jsonFieldBtn").unbind().bind("click",function(){jsonFieldLayer()}),o.find(".parm-list").empty(),a?(setDomAllVals(o[0],a),addParmItemForEdit(tempLayeroForSets,a,o.find("#DataSourceName").val())):setDomAllVals(o[0],{isvalid:!0,pageType:0,method:0,cate:0}),$(o).find("#jblist").hide(),$(o).find("#ddslist").hide(),$(o).find("#jsonlist").hide(),"javabean"==o.find("#DataSourceName").val()?($(o).find("#jblist").show(),o.find("#FactoryClass").val(a.commandText)):"json"==o.find("#DataSourceName").val()?($(o).find("#jsonlist").show(),a&&(1==a.pageType&&$("#pageprop").show(),getJsonfieldsByTree(o,a))):$(o).find("#ddslist").show(),$(document).dequeue("dsQuery")}),$(document).dequeue("dsQuery")},end:function(){tempLayeroForSets=null},btn:["保存","取消"],yes:function(e,t){(a?"json"==$(t).find("#DataSourceName").val()?editSetsJSONNode(t,a):editSetsNode(t,a):"json"==$(t).find("#DataSourceName").val()?addSetsJSONNode(t):addSetsNode(t))&&layer.close(e)},btn2:function(e,t){layer.close(e)}})}function addSetsJSONNode(e){var t=getDomAllVals(e.find(".form-info")[0]),a=t.dataSetName,o=t.hostName,n=e.data("jsonfields");if(""==o)return window.top.layer.tips("请选择数据源",$(e).find("#hostName"),{tipsMore:!0}),!1;if(""==a)return window.top.layer.tips("数据集名称不能为空",$(e).find("#DataSetName"),{tipsMore:!0}),!1;var d=$.fn.zTree.getZTreeObj("dataSets"),i=d.getNodes(),r=$.extend(!0,{},t);r.name=t.dataSetName,r=d.addNodes(i[0],r);var s={name:"字段",type:"field",open:!1},l={name:"参数",type:"parms",open:!1};s=d.addNodes(r[0],s),l=d.addNodes(r[0],l);var m=getParmListVals(e.find("#jsonlist .parm-list")[0]);if(d.addNodes(l[0],m),n&&0<n.length){var c=[];$.each(n,function(e,t){var a=t;a.columnComments?a.name=a.columnComments:a.name=a.columnName,c.push(a)}),d.addNodes(s[0],c)}else d.addNodes(s[0],[]);return t.dic&&settingDic(s[0]),!0}function addSetsNode(r){var s,l=getDomAllVals(r.find(".form-info")[0]),e=l.dataSetName,t=l.dataSourceName,m=!0;return""==t?(window.top.layer.tips("请选择数据源",$(r).find("#DataSourceName"),{tipsMore:!0}),!1):""==e?(window.top.layer.tips("数据集名称不能为空",$(r).find("#DataSetName"),{tipsMore:!0}),!1):("javabean"==t&&(l.commandText=l.factoryClass),$(document).queue("addDsQuery",function(){(l.dic||l.isvalid||"javabean"==t)&&$.rdp.ajax({url:"../../rdp/parFieldsForJSON",type:"post",async:!1,data:{dataSourceName:l.dataSourceName,dataSetType:l.dataSetType,value:Base64Util.encode64(l.commandText.replace(/\n/g," "))},success:function(e){0==e.code?(s=e.list,layer.msg("校验通过，保存成功",{time:2e3})):(layer.msg(e.msg),layer.closeAll("loading"),m=!1),$(document).dequeue("addDsQuery")},error:function(){layer.tips("sql错误",$(tempLayeroForSets).find("#CommandText"),{tipsMore:!0}),layer.closeAll("loading"),m=!1},beforeSend:function(){layer.load(1,{shade:[.1,"#fff"]})},complete:function(){layer.closeAll("loading")}})}),$(document).queue("addDsQuery",function(){if(m){var e=$.fn.zTree.getZTreeObj("dataSets"),t=e.getNodes(),a=$.extend(!0,{},l);a.name=l.dataSetName,a=e.addNodes(t[0],a);var o={name:"字段",type:"field",open:!1},n={name:"参数",type:"parms",open:!1};o=e.addNodes(a[0],o),n=e.addNodes(a[0],n);var d=getParmListVals(r.find("#ddslist .parm-list")[0]);if(e.addNodes(n[0],d),s&&0<s.length){var i=[];$.each(s,function(e,t){var a=t;a.columnComments?a.name=a.columnComments:a.name=a.columnName,i.push(a)}),e.addNodes(o[0],i)}else e.addNodes(o[0],[]);l.dic&&settingDic(o[0])}$(document).dequeue("addDsQuery")}),$(document).dequeue("addDsQuery"),m)}function getJsonfieldsByTree(e,t){var a=$.fn.zTree.getZTreeObj("dataSets").getNodesByParam("type","field",t);e.data("jsonfields",a[0].children)}function editSetsJSONNode(e,t){var a=$.fn.zTree.getZTreeObj("dataSets"),o=getDomAllVals(e.find(".form-info")[0]),n=o.dataSetName,d=o.hostName,i=e.data("jsonfields");if(""==d)return window.top.layer.tips("请选择数据源",$(e).find("#hostName"),{tipsMore:!0}),!1;if(""==n)return window.top.layer.tips("数据集名称不能为空",$(e).find("#DataSetName"),{tipsMore:!0}),!1;(t=$.extend(!0,t,o)).name=o.dataSetName,a.updateNode(t);var r=a.getNodesByParam("type","field",t);if(a.removeChildNodes(r[0]),i&&0<i.length){var s=[];$.each(i,function(e,t){var a=t;a.columnComments?a.name=a.columnComments:a.name=a.columnName,s.push(a)}),a.addNodes(r[0],s)}else a.addNodes(r[0],[]);var l=a.getNodesByParam("type","parms",t);a.removeChildNodes(l[0]);var m=getParmListVals(e.find("#jsonlist .parm-list")[0]);return a.addNodes(l[0],m),!0}function editSetsNode(d,i){var r,s=$.fn.zTree.getZTreeObj("dataSets"),l=getDomAllVals(d.find(".form-info")[0]),m=!0,e=l.dataSetName,t=l.dataSourceName;return""==t?(window.top.layer.tips("请选择数据源",$(layero).find("#DataSourceName"),{tipsMore:!0}),!1):""==e?(window.top.layer.tips("数据集名称不能为空",$(layero).find("#DataSetName"),{tipsMore:!0}),!1):("javabean"==t&&(l.commandText=l.factoryClass),(i=$.extend(!0,i,l)).name=l.dataSetName,s.updateNode(i),(l.dic||l.isvalid||"javabean"==t)&&$.rdp.ajax({url:"../../rdp/parFieldsForJSON",type:"post",async:!1,data:{dataSourceName:l.dataSourceName,dataSetType:l.dataSetType,value:Base64Util.encode64(l.commandText.replace(/\n/g," "))},success:function(e){if(0==e.code){r=e.list;var t=s.getNodesByParam("type","field",i);if(s.removeChildNodes(t[0]),r&&0<r.length){var o=[];$.each(r,function(e,t){var a=t;a.columnComments?a.name=a.columnComments:a.name=a.columnName,o.push(a)}),s.addNodes(t[0],o)}else s.addNodes(t[0],[]);l.dic&&settingDic(t[0]);var a=s.getNodesByParam("type","parms",i);s.removeChildNodes(a[0]);var n=getParmListVals(d.find("#ddslist .parm-list")[0]);s.addNodes(a[0],n),layer.msg("校验通过，保存成功",{time:2e3})}else layer.alert(e.msg),m=!1},error:function(){layer.tips("sql错误",$(tempLayeroForSets).find("#CommandText"),{tipsMore:!0}),m=!1},beforeSend:function(){layer.load(1,{shade:[.1,"#fff"]})},complete:function(){layer.closeAll("loading")}}),m)}function getParmListVals(e){for(var t=[],a=e.getElementsByTagName("SELECT"),o=0;o<a.length;o++){var n={},d=a[o].selectedIndex,i="";a[o].options[d]&&(i=a[o].options[d].text),n.name=i,n.parmCName=i,n.parmName=a[o].value,t.push(n)}return t}function settingDic(n){layer.open({type:1,area:["540px","164px"],title:"数据集字典项配置",content:$("#dataSetsDic"),cancel:function(){},success:function(e,t){e.find("#dicType").empty(),e.find("#dicID").empty(),e.find("#dicText").empty(),e.find("#dicType").append('<option value="">请选择字典类型</option>'),e.find("#dicID").append('<option value="">请选择字段名称</option>'),e.find("#dicText").append('<option value="">请选择值名称</option>');var a=n.children;$.each(a,function(e,t){$("#dicType").append('<option value="'+t.columnName+'">'+t.columnName+"</option>"),$("#dicID").append('<option value="'+t.columnName+'">'+t.columnName+"</option>"),$("#dicText").append('<option value="'+t.columnName+'">'+t.columnName+"</option>")});var o=n.getParentNode();e.find("#dicType").val(o.keyName),e.find("#dicText").val(o.optName),e.find("#dicID").val(o.optCode)},end:function(){},btn:["保存","取消"],yes:function(e,t){var a=$.fn.zTree.getZTreeObj("dataSets"),o=n.getParentNode();o.keyName=t.find("#dicType").val(),o.optName=t.find("#dicText").val(),o.optCode=t.find("#dicID").val(),a.updateNode(o),layer.close(e)},btn2:function(e,t){layer.close(e)}})}function jsonFieldLayer(){layer.open({type:1,area:["540px","90%"],title:"JSON数据字段配置",content:$("#jsonFieldLayer"),cancel:function(){},success:function(e,t){tempLayeroForJsonField=e;tempLayeroForSets.find("#node").val();e.find("#jsonFieldList").empty(),tempLayeroForSets.data("jsonfields")&&$.each(tempLayeroForSets.data("jsonfields"),function(e,t){addJSONfieldItem(tempLayeroForJsonField,t)}),e.find("#EditJsonFieldBtn").bind("click",function(){var e=getDomAllVals(tempLayeroForJsonField.find("#jsonFieldParm")[0]);if(""==e.columnName||""==e.columnType)return window.top.layer.msg("字段名称和字段类型不能为空！"),!1;addJSONfieldItem(tempLayeroForJsonField,e)}),e.find("#GetJsonFieldBtn").bind("click",function(){var t=tempLayeroForSets.find("#cate").val(),e=tempLayeroForSets.find("#path").val();if("1"==tempLayeroForSets.find("#pageType").val()){var a=tempLayeroForSets.find("#pageParam").val();""!=a&&-1!=e.indexOf("?")&&(e+="&"+a+"=1");var o=tempLayeroForSets.find("#pageSizeParam").val();""!=o&&-1!=e.indexOf("?")&&(e+="&"+o+"=10")}$.rdp.ajax({url:"../../rdp/getJSONDataByUrl",type:"get",async:!1,data:{dataSourceName:tempLayeroForSets.find("#hostName").val(),path:e,method:tempLayeroForSets.find("#method").val()},success:function(e){0==e.code?addJSONfieldItemByData(tempLayeroForJsonField,e,t):window.top.layer.msg("获取数据发生错误！")}})}),e.find("#node").val(tempLayeroForSets.find("#node").val())},end:function(){},btn:["保存","取消"],yes:function(e,t){tempLayeroForSets.data("jsonfields",getJsonFields(t)),console.log(tempLayeroForSets.data()),layer.close(e)},btn2:function(e,t){layer.close(e)}})}function addJSONfieldItem(e,t){var a=e.find("#jsonFieldList"),o=a.find("li[keyName="+MD5Util.hex_md5(t.columnName)+"]");o&&0<o.length||(o=$('<li class="field-item"><span class="field-name"></span> <span class="field-type"></span> <span class="field-comment"></span><button class="DelJsonFieldBtn" type="button" ><i class="fa fa-minus-circle"></i></button></li>'),a.prepend(o),o.find(".DelJsonFieldBtn").bind("click",function(){$(this).parent().remove()}),o.attr("keyName",MD5Util.hex_md5(t.columnName)),o.bind("click",function(){setDomAllVals(e.find("#jsonFieldParm")[0],o.data())})),o.data(t),o.find(".field-name").html(t.columnName),o.find(".field-type").html(t.columnType),o.find(".field-comment").html(t.columnComments)}function addJSONfieldItemByData(o,e,t){var a,n,d=o.find("#node").val(),i=e.list;try{if(d){var r=[];r=-1<d.indexOf("[")?(d=d.replace(/]/g,"")).split("["):[d],a=i;for(var s=0;s<r.length;s++){if(!a.hasOwnProperty(r[s]))return window.top.layer.msg("未找到匹配的KEY！"),!1;a=a[r[s]]}}else a=i}catch(e){window.top.layer.msg("匹配KEY发生错误，请确认KEY无误！")}n=Type.IsArray(a)?a[0]:a,$.each(n,function(e,t){var a={};a.columnName=e,a.columnComments="",a.isauto=1,Type.IsString(t)||null==t||"null"==t?(a.columnType="string",addJSONfieldItem(o,a)):Type.IsNumber(t)?(a.columnType="number",addJSONfieldItem(o,a)):Type.IsBoolean(t)&&(a.columnType="boolean",addJSONfieldItem(o,a))})}function getJsonFields(e){var t=[];return $.each(e.find("#jsonFieldList > .field-item"),function(){t.push($(this).data())}),t}var Type=function(){for(var e={},t=["String","Object","Number","Array","Undefined","Function","Null","Symbol","Boolean"],a=0;a<t.length;a++)!function(t){e["Is"+t]=function(e){return Object.prototype.toString.call(e)=="[object "+t+"]"}}(t[a]);return e}();